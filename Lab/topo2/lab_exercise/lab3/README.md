# Lab exercise 3, configure SR-MPLS (Segment Routing)
## Objective

In this lab, we are going to configure SR-MPLS (Segment Routing with MPLS forwarding)

The following configuration will be done on the network devices: 
1. Enable Segment routing for IS-IS routing protocol

2. Verify that both label are distributed using SR and LDP

3. disable LDP and RSVP to allow routers to use label generated by SR-ISIS


4. verify that exiting service, IP Routing, L3VPN and EVPN are still working over SR-MPLS


## Configure PE router for L3VPN for customer1


1. Use ansible playbook [set_sr.yaml](set_sr.yaml) to deploy configuration SR configuration to all vJunos nodes

        cd ~/git/vmm-v3-script/Lab/topo2/lab_exercise/lab3/
        ansible-playbook set_sr.yaml

2. Open ssh session into one of the vJunos node and verify that SR label has been allocated. if SRGB Block Allocation failed, you may need to reboot the node.

        ssh pe1
        show isis overview

        admin@pe1> show isis overview
        Instance: master
        Router ID: 10.100.255.1
        IPv6 Router ID: fc00:dead:beef:a211::
        Hostname: pe1
        Sysid: 0001.0001.0001
        Areaid: 49.0001
        Adjacency holddown: enabled
        Maximum Areas: 3
        LSP life time: 1200
        Attached bit evaluation: enabled
        SPF delay: 200 msec, SPF holddown: 5000 msec, SPF rapid runs: 3
        IPv4 is enabled, IPv6 is enabled, SPRING based MPLS is enabled
        Traffic engineering: enabled
        Traffic engineering v6: disabled
        Restart: Disabled
            Helper mode: Enabled
        Layer2-map: Disabled
        Source Packet Routing (SPRING): Enabled
            SRGB Config Range :
            SRGB Start-Label : 400000, SRGB Index-Range : 5000
            SRGB Block Allocation: Success
            SRGB Start Index : 400000, SRGB Size : 5000, Label-Range: [ 400000, 404999 ]
            Node Segments: Enabled
            Ipv4 Index : 101
            SRv6: Disabled
        Post Convergence Backup: Enabled
            Max labels: 3, Max spf: 100, Max Ecmp Backup: 8
        Level 1
            Internal route preference: 15
            External route preference: 160
            Prefix export count: 0
            Wide metrics are enabled, Narrow metrics are enabled
            Flood-reduction: Disabled
            Hash-reflooder: Enabled
            Source Packet Routing is enabled
        Level 2
            Internal route preference: 18
            External route preference: 165
            Prefix export count: 0
            Wide metrics are enabled, Narrow metrics are enabled
            Flood-reduction: Disabled
            Hash-reflooder: Enabled
            Source Packet Routing is enabled

3. Open ssh session into one of the nodes, and verify that loopback ip addresses of the vjunos node are assigned with label from LDP and SR-ISIS

        ssh pe1
        show route 10.100.255.3
        admin@pe1> show route 10.100.255.3

        inet.0: 38 destinations, 38 routes (38 active, 0 holddown, 0 hidden)
        + = Active Route, - = Last Active, * = Both

        10.100.255.3/32    *[IS-IS/18] 19:14:02, metric 30
                            >  to 10.100.0.3 via ge-0/0/2.0

        inet.3: 9 destinations, 18 routes (9 active, 0 holddown, 0 hidden)
        + = Active Route, - = Last Active, * = Both

        10.100.255.3/32    *[LDP/9] 00:00:41, metric 1
                            >  to 10.100.0.3 via ge-0/0/2.0, Push 40
                            [L-ISIS/14] 19:13:52, metric 30
                            >  to 10.100.0.3 via ge-0/0/2.0, Push 400103
                            to 10.100.0.1 via ge-0/0/1.0, Push 400103


4. as for now, the mpls forwarding on the network is still using label generated from LDP, because LDP has lower route preference value (9) compare to SR-ISIS has route preference value 14.

5. Use ansible playbook [disable_ldp_rsvp.yaml](disable_ldp_rsvp.yaml) to disable LDP/RSVP on vJunos node

        ansible-playbook disable_ldp_rsvp.yaml

6. open ssh session to one of the nodes, and verify that loopback ip addresses of the vjunos node are assigned with label from SR-ISIS


        ssh pe1
        Last login: Wed Sep 17 09:16:14 2025 from 172.16.10.254
        --- JUNOS 25.2R1.9 Kernel 64-bit  JNPR-15.0-20250603.72f4182_buil
        admin@pe1> show route 10.100.255.3

        inet.0: 37 destinations, 37 routes (37 active, 0 holddown, 0 hidden)
        + = Active Route, - = Last Active, * = Both

        10.100.255.3/32    *[IS-IS/18] 21:33:07, metric 30
                            >  to 10.100.0.3 via ge-0/0/2.0

        inet.3: 9 destinations, 9 routes (9 active, 0 holddown, 0 hidden)
        + = Active Route, - = Last Active, * = Both

        10.100.255.3/32    *[L-ISIS/14] 21:32:57, metric 30
                            >  to 10.100.0.3 via ge-0/0/2.0, Push 400103
                            to 10.100.0.1 via ge-0/0/1.0, Push 400103

        admin@pe1>

7. open ssh session into node client, and test connectivity between LXC container from the previous lab exercise

        ssh client
        ubuntu@client:~$ lxc exec lab1cl1-101 sh
        ~ # ping lab1cl3-101
        PING lab1cl3-101 (172.16.223.101): 56 data bytes
        64 bytes from 172.16.223.101: seq=0 ttl=58 time=7.675 ms
        ^C
        --- lab1cl3-101 ping statistics ---
        2 packets transmitted, 1 packets received, 50% packet loss
        round-trip min/avg/max = 7.675/7.675/7.675 ms
        ~ # ping6 lab1cl3-101
        PING lab1cl3-101 (fc00:dead:beef:a223::1000:101): 56 data bytes
        64 bytes from fc00:dead:beef:a223::1000:101: seq=0 ttl=58 time=6.956 ms
        64 bytes from fc00:dead:beef:a223::1000:101: seq=1 ttl=58 time=7.379 ms
        ^C
        --- lab1cl3-101 ping statistics ---
        2 packets transmitted, 2 packets received, 0% packet loss
        round-trip min/avg/max = 6.956/7.167/7.379 ms
        ~ # ssh root@lab1cl3-101
        root@lab1cl3-101's password:
        Welcome to Alpine!

        The Alpine Wiki contains a large amount of how-to guides and general
        information about administrating Alpine systems.
        See <https://wiki.alpinelinux.org/>.

        You can setup the system with the command: setup-alpine

        You may change this message by editing /etc/motd.

        lab1cl3-101:~# netstat -n | grep ESTAB
        tcp        0     36 172.16.223.101:22       172.16.221.101:43516    ESTABLISHED
        lab1cl3-101:~# exit

        ~ # ssh -6 root@lab1cl3-101
        root@lab1cl3-101's password:
        Welcome to Alpine!

        The Alpine Wiki contains a large amount of how-to guides and general
        information about administrating Alpine systems.
        See <https://wiki.alpinelinux.org/>.

        You can setup the system with the command: setup-alpine

        You may change this message by editing /etc/motd.

        lab1cl3-101:~# netstat -n | grep ESTAB
        tcp        0     36 fc00:dead:beef:a223::1000:101:22 fc00:dead:beef:a221::1000:101:53714 ESTABLISHED
        lab1cl3-101:~#

